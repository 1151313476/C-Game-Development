# 羊了个羊项目架构分析

## 1. 技术框架

### 开发引擎
- **Cocos Creator 3.x**: 基于TypeScript的游戏引擎
- **渲染系统**: 2D精灵渲染，支持图集和动画
- **物理系统**: 无物理引擎，纯逻辑碰撞检测
- **音频系统**: 内置音频管理器，支持背景音乐和音效

### 项目结构
```
SheepProject/
├── assets/
│   ├── Scripts/          # 核心脚本
│   ├── Scenes/           # 场景文件
│   ├── Prefabs/          # 预制体
│   ├── Sprites/          # 图片资源
│   ├── Audio/            # 音频资源
│   └── AnimationClip/    # 动画文件
├── library/              # 引擎库文件
├── settings/             # 项目配置
└── temp/                 # 临时文件
```

## 2. 核心架构设计

### 2.1 单例模式管理器
```typescript
// 数据管理器 - 游戏状态持久化
@ccclass('DataManager')
export class DataManager {
    private static _instance: DataManager;
    static get instance() { return this._instance; }
    
    // 游戏数据
    blocks: Block[] = [];           // 所有方块
    records: Block[] = [];          // 操作记录栈
    currentLevel: LevelType = null; // 当前关卡
    gameStatus: GAME_STATUS_ENUM;   // 游戏状态
}

// 游戏管理器 - 核心逻辑控制
@ccclass('GameManager')
export class GameManager extends Component {
    // 游戏初始化、状态管理、事件处理
}

// 音频管理器 - 音效控制
@ccclass('MusicManager')
export class MusicManager extends Component {
    // 背景音乐、音效播放
}
```

### 2.2 事件驱动架构
```typescript
// 事件枚举
enum GAME_EVENT_ENUM {
    CHANGE_BOARD,    // 方块移动
    CHECK_CLEAR,     // 检查消除
    CHECK_LOSED,     // 检查失败
    CHECK_COMPLETE,  // 检查完成
    PLAY_AUDIO       // 播放音效
}

// 事件系统
const CHANGE_BOARD = new EventTarget();
const CHECK_CLEAR = new EventTarget();
// ... 其他事件
```

### 2.3 组件化设计
```typescript
// 方块组件 - 核心游戏对象
@ccclass('Block')
export class Block extends Component {
    // 位置、层级、点击、渲染
}

// 特效组件 - 消除动画
@ccclass('Broken')
export class Broken extends Component {
    // 动画播放、生命周期
}
```

## 3. 功能模块分析

### 3.1 关卡系统
**实现方式**: 静态配置 + 动态生成
```typescript
// 关卡数据结构
interface LevelType {
    chessWidthNum: number;    // 棋盘尺寸
    levelNum: number;         // 层数
    levelBlockNum: number;    // 每层块数
    blockTypeNum: number;     // 方块类型数
    leftRandomBlocks: number; // 左随机块数
    rightRandomBlocks: number;// 右随机块数
}

// 关卡生成流程
1. 读取关卡配置
2. 计算总块数
3. 生成方块类型数组
4. 随机打乱分配
5. 按区域分配位置
```

### 3.2 消除机制
**实现方式**: 三层重叠 + 槽位系统
```typescript
// 消除条件
- 相同类型方块收集3个
- 方块未被其他方块覆盖
- 槽位未满(最多7个)

// 消除流程
1. 点击方块 → 检查可点击性
2. 移动到槽位 → 更新层级关系
3. 检查消除 → 3个相同类型
4. 执行消除 → 播放动画
```

### 3.3 技能系统
**实现方式**: 扩展区 + 撤销 + 洗牌
```typescript
// 扩展技能
- 将槽位方块移动到扩展区
- 扩展区最多容纳7个方块

// 撤销技能
- 操作记录栈管理
- 支持多步撤销

// 洗牌技能
- 重新排列主游戏区方块
- 保持层级关系不变
```

### 3.4 随机化算法
**实现方式**: Fisher-Yates洗牌算法
```typescript
export function shuffle(arr: any[]) {
    let length = arr.length, randomIndex, temp;
    while (length) {
        randomIndex = Math.floor(Math.random() * (length--));
        temp = arr[randomIndex];
        arr[randomIndex] = arr[length];
        arr[length] = temp;
    }
    return arr;
}
```

## 4. 数据流设计

### 4.1 状态管理
```typescript
enum GAME_STATUS_ENUM {
    INIT,       // 初始化
    RUNNING,    // 运行中
    CLEAR,      // 消除中
    LOSED,      // 失败
    COMPLETE    // 完成
}
```

### 4.2 数据持久化
```typescript
// 存储策略
- 仅保存关卡进度
- localStorage存储
- JSON格式序列化

// 存储内容
{
    level: number  // 当前关卡号
}
```

### 4.3 内存管理
```typescript
// 对象池模式
- 方块预制体复用
- 动画对象回收
- 节点层级清理
```

## 5. 性能优化策略

### 5.1 渲染优化
- **图集打包**: 减少DrawCall
- **层级管理**: 避免过度绘制
- **对象复用**: 减少GC压力

### 5.2 逻辑优化
- **事件驱动**: 减少轮询
- **状态机**: 简化状态管理
- **算法优化**: 高效洗牌和碰撞检测

### 5.3 内存优化
- **轻量存储**: 只保存必要数据
- **及时清理**: 游戏结束时清理资源
- **延迟加载**: 按需加载资源

## 6. 扩展性设计

### 6.1 关卡扩展
- 新增关卡只需添加配置
- 支持动态难度调整
- 可扩展更多游戏模式

### 6.2 功能扩展
- 技能系统可扩展
- 特效系统模块化
- UI系统组件化

### 6.3 平台适配
- 支持Web、移动端
- 响应式UI设计
- 多分辨率适配

## 7. 技术亮点总结

1. **架构清晰**: 单例模式 + 事件驱动
2. **模块化设计**: 功能模块独立
3. **性能优化**: 对象复用 + 轻量存储
4. **扩展性强**: 配置化 + 组件化
5. **用户体验**: 流畅动画 + 完整音效 