# 事件监听系统分析

## 1. **事件系统架构**

### 核心事件定义
```typescript
// Event.ts - 全局事件实例
export const CHANGE_BOARD = new EventTarget();    // 棋盘变化事件
export const CHECK_CLEAR = new EventTarget();      // 检查清除事件
export const CHECK_LOSED = new EventTarget();      // 检查失败事件
export const CHECK_COMPLETE = new EventTarget();   // 检查完成事件
export const PLAY_AUDIO = new EventTarget();       // 播放音频事件
export const PLAY_BROKEN = new EventTarget();      // 播放爆炸特效事件
```

### 事件类型枚举
```typescript
export enum GAME_EVENT_ENUM {
    CHECK_CLEAR = "CHECK_CLEAR",      // 游戏检查清除事件
    CHECK_LOSED = "CHECK_LOSED",      // 游戏检查失败事件
    CHECK_COMPLETE = "CHECK_COMPLETE", // 游戏检查完成事件
    CHANGE_BOARD = "CHANGE_BOARD",    // 更改游戏面板事件
    PLAY_AUDIO = "PLAY_AUDIO",        // 播放音频事件
    PLAY_BROKEN = "PLAY_BROKEN",      // 播放爆炸特效
}
```

## 2. **事件监听模式**

### 2.1 全局游戏事件监听
```typescript
// GameManager.ts - 游戏主管理器的事件监听
protected onLoad(): void {
    // 注册所有游戏核心事件
    CHANGE_BOARD.on(GAME_EVENT_ENUM.CHANGE_BOARD, this.onBoardChange, this)
    CHECK_CLEAR.on(GAME_EVENT_ENUM.CHECK_CLEAR, this.onClearCheck, this)
    CHECK_LOSED.on(GAME_EVENT_ENUM.CHECK_LOSED, this.onLosedCheck, this)
    CHECK_COMPLETE.on(GAME_EVENT_ENUM.CHECK_COMPLETE, this.onCompleteCheck, this)
}
```

### 2.2 音频事件监听
```typescript
// MusicManager.ts - 音频管理器的事件监听
protected onLoad(): void {
    // 注册音频播放事件
    PLAY_AUDIO.on(GAME_EVENT_ENUM.PLAY_AUDIO, this.onAudioPlay, this);
    // 注册场景切换事件
    director.on(Director.EVENT_AFTER_SCENE_LAUNCH, this.onSceneLaunched, this);
}
```

### 2.3 特效事件监听
```typescript
// BrokenManager.ts - 特效管理器的事件监听
protected onLoad(): void {
    PLAY_BROKEN.on(GAME_EVENT_ENUM.PLAY_BROKEN, this.onBrokenBuild, this)
}
```

## 3. **事件触发机制**

### 3.1 方块点击事件触发
```typescript
// Block.ts - 方块点击时触发多个事件
onTouchStart(e: EventTouch) {
    // 播放点击音效
    PLAY_AUDIO.emit(GAME_EVENT_ENUM.PLAY_AUDIO, AUDIO_EFFECT_ENUM.CLICKBOLCK);
    // 播放破碎特效
    PLAY_BROKEN.emit(GAME_EVENT_ENUM.PLAY_BROKEN, pos, this)
    // 执行方块移动
    this.toSlot();
}
```

### 3.2 游戏状态事件触发
```typescript
// GameManager.ts - 游戏状态变化时触发事件
onClearCheck(block: Block) {
    if (targets.length >= DataManager.instance.currentLevel.clearableNum) {
        // 触发消除音效
        PLAY_AUDIO.emit(GAME_EVENT_ENUM.PLAY_AUDIO, AUDIO_EFFECT_ENUM.CLEAR)
        // 播放消除动画
        anim.play();
    }
}

onLosedCheck() {
    // 触发失败音效
    PLAY_AUDIO.emit(GAME_EVENT_ENUM.PLAY_AUDIO, AUDIO_EFFECT_ENUM.LOSE)
    // 显示失败界面
    this.gameOverNode.active = true;
}
```

## 4. **事件处理回调**

### 4.1 音频事件处理
```typescript
// MusicManager.ts - 音频事件回调处理
onAudioPlay(type: AUDIO_EFFECT_ENUM) {
    switch (type) {
        case AUDIO_EFFECT_ENUM.CLICKBUTTON:
            this.audioSource.playOneShot(this.clickButton);
            break;
        case AUDIO_EFFECT_ENUM.CLEAR:
            this.audioSource.playOneShot(this.clear);
            break;
        case AUDIO_EFFECT_ENUM.CLICKBOLCK:
            this.audioSource.playOneShot(this.clickBlock);
            break;
        case AUDIO_EFFECT_ENUM.LOSE:
            this.audioSource.playOneShot(this.lose);
            break;
        case AUDIO_EFFECT_ENUM.WIN:
            this.audioSource.playOneShot(this.win);
            break;
    }
}
```

### 4.2 特效事件处理
```typescript
// BrokenManager.ts - 特效事件回调处理
onBrokenBuild(pos: Vec2, block: Block) {
    // 创建破碎特效节点
    let node: Node = new Node();
    // 生成随机数量的碎片
    let nums = getRandom(2, 4);
    // 为每个碎片应用物理力
    for (let i = 0; i < nums; i++) {
        // 创建碎片并设置位置、力等
    }
}
```

## 5. **事件清理机制**

### 5.1 组件销毁时清理事件
```typescript
// GameManager.ts - 清理游戏事件
protected onDestroy(): void {
    CHANGE_BOARD.off(GAME_EVENT_ENUM.CHANGE_BOARD, this.onBoardChange, this)
    CHECK_CLEAR.off(GAME_EVENT_ENUM.CHECK_CLEAR, this.onClearCheck, this)
    CHECK_LOSED.off(GAME_EVENT_ENUM.CHECK_LOSED, this.onLosedCheck, this)
    CHECK_COMPLETE.off(GAME_EVENT_ENUM.CHECK_COMPLETE, this.onCompleteCheck, this)
}

// MusicManager.ts - 清理音频事件
protected onDestroy(): void {
    director.off(Director.EVENT_AFTER_SCENE_LAUNCH, this.onSceneLaunched, this);
    PLAY_AUDIO.off(GAME_EVENT_ENUM.PLAY_AUDIO, this.onAudioPlay, this);
}
```

### 5.2 动画事件清理
```typescript
// GameManager.ts - 清理动画事件
let anim = target.node.getComponent(Animation);
anim.off(Animation.EventType.PLAY, this.onClearPlay, target)
anim.on(Animation.EventType.PLAY, this.onClearPlay, target)
anim.off(Animation.EventType.STOP, this.onClearStop, target)
anim.on(Animation.EventType.STOP, this.onClearStop, target)
```

## 6. **事件系统特点**

### 6.1 松耦合设计
- **事件发布者**：不需要知道谁在监听
- **事件监听者**：不需要知道谁在发布
- **解耦优势**：组件间通过事件通信，降低耦合度

### 6.2 多层级事件
- **全局事件**：游戏状态、音频、特效等
- **组件事件**：方块点击、动画播放等
- **系统事件**：场景切换、输入事件等

### 6.3 事件生命周期管理
- **注册时机**：组件onLoad时注册事件
- **清理时机**：组件onDestroy时清理事件
- **防止内存泄漏**：确保事件监听器正确移除

## 7. **事件流程示例**

### 方块点击完整流程：
1. **用户点击** → `Block.onTouchStart()`
2. **触发音效** → `PLAY_AUDIO.emit()` → `MusicManager.onAudioPlay()`
3. **触发特效** → `PLAY_BROKEN.emit()` → `BrokenManager.onBrokenBuild()`
4. **方块移动** → `Block.toSlot()` → `CHANGE_BOARD.emit()`
5. **检查消除** → `CHECK_CLEAR.emit()` → `GameManager.onClearCheck()`
6. **播放动画** → `Animation.play()` → `GameManager.onClearPlay/Stop()`
