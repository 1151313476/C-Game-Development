# 羊了个羊项目功能分析

## 1. 核心游戏功能

### 1.1 消除机制
**功能描述**: 三层重叠方块的消除系统
**实现方式**: 
```typescript
// 消除条件检查
- 相同类型方块收集3个
- 方块未被其他方块覆盖 (higherIds.length <= 0)
- 槽位未满 (最多7个)

// 消除流程
1. 点击方块 → 检查可点击性
2. 移动到槽位 → 更新层级关系
3. 检查消除 → 3个相同类型
4. 执行消除 → 播放动画
```

**技术实现**:
- 层级关系管理 (`higherIds`/`lowerIds`)
- 可点击状态判断
- 槽位排序和类型匹配
- 消除动画播放

### 1.2 槽位系统
**功能描述**: 7个槽位临时存放方块
**实现方式**:
```typescript
// 槽位管理
- 最多容纳7个方块
- 按类型分组存储
- 支持随时消除
- 层级排序显示

// 槽位操作
toSlot() {
    // 更新层级关系
    // 记录操作历史
    // 重新排序
    // 检查消除
}
```

### 1.3 关卡系统
**功能描述**: 4个难度递增的关卡
**实现方式**:
```typescript
// 关卡配置
关卡1: 2层×9块，3种类型，无随机区
关卡2: 4层×9块，6种类型，左右各4个随机块
关卡3: 8层×16块，12种类型，左右各6个随机块
关卡4: 10层×18块，14种类型，左右各8个随机块

// 关卡生成
1. 读取关卡配置
2. 计算总块数
3. 生成方块类型数组
4. 随机打乱分配
5. 按区域分配位置
```

## 2. 技能系统

### 2.1 扩展技能
**功能描述**: 将槽位方块移动到扩展区
**实现方式**:
```typescript
onGameExtend() {
    // 获取槽位方块
    let slot_blocks = DataManager.instance.blocks.filter(
        item => item.boardType == GAME_BOARD_ENUM.SLOT
    );
    
    // 检查扩展区容量
    let extend_blocks = DataManager.instance.blocks.filter(
        item => item.boardType == GAME_BOARD_ENUM.LEVEL_EXTEND
    );
    
    // 移动方块 (最多3个)
    let nums = Math.min(3, 7 - extend_blocks.length, slot_blocks.length);
    for (let i = 0; i < nums; i++) {
        slot_blocks[i].boardType = GAME_BOARD_ENUM.LEVEL_EXTEND;
        slot_blocks[i].rendor();
    }
}
```

### 2.2 撤销技能
**功能描述**: 撤销上一步操作
**实现方式**:
```typescript
OnGameUndo() {
    // 从操作记录栈弹出
    const block: Block = DataManager.instance.records.pop();
    
    // 恢复方块状态
    block.toSlotCancel();
}

// 撤销恢复逻辑
toSlotCancel() {
    // 恢复层级关系
    // 恢复原始位置
    // 恢复原始状态
    // 重新渲染
}
```

### 2.3 洗牌技能
**功能描述**: 重新排列剩余方块
**实现方式**:
```typescript
OnGameshuffle() {
    // 获取主游戏区方块
    let level_blocks = DataManager.instance.blocks.filter(
        item => item.boardType == GAME_BOARD_ENUM.LEVEL
    );
    
    // 打乱方块类型
    let contents = shuffle(level_blocks.map(item => item.type));
    
    // 重新分配类型
    level_blocks.forEach((block, index) => {
        block.type = contents[index];
        block.rendor();
    });
}
```

## 3. 区域系统

### 3.1 主游戏区 (LEVEL)
**功能描述**: 多层重叠的方块区域
**实现方式**:
- 棋盘网格管理
- 层级关系建立
- 位置随机/规律生成
- 边界收缩逻辑

### 3.2 随机区域 (RANDOM_LEFT/RANDOM_RIGHT)
**功能描述**: 左右两侧的随机方块区域
**实现方式**:
```typescript
// 左侧随机区域
for (let i = 0; i < currentLevel.leftRandomBlocks; i++) {
    blockArr[pos].boardType = GAME_BOARD_ENUM.RANDOM_LEFT;
    blockArr[pos].x -= i * 5;  // 水平偏移
    blockArr[pos].y = 0;
    blockArr[pos].level -= i + 10;  // 层级递减
}
```

### 3.3 扩展区 (LEVEL_EXTEND)
**功能描述**: 技能扩展区域
**实现方式**:
- 最多容纳7个方块
- 支持随时点击
- 与槽位系统联动

### 3.4 槽位区 (SLOT)
**功能描述**: 临时存放方块的区域
**实现方式**:
- 7个槽位限制
- 按类型分组
- 支持消除操作

## 4. 音频系统

### 4.1 背景音乐
**功能描述**: 场景切换时的背景音乐
**实现方式**:
```typescript
updateBackGroundMusic(sceneName: string) {
    if (sceneName == "Main") {
        this.audioSource.clip = this.mainBgm;
    } else if (sceneName === 'Game') {
        this.audioSource.clip = this.gameBgm;
    }
    this.audioSource.play();
}
```

### 4.2 音效系统
**功能描述**: 游戏交互音效
**音效类型**:
- `CLICKBUTTON`: 按钮点击音效
- `CLEAR`: 消除音效
- `CLICKBOLCK`: 方块点击音效
- `LOSE`: 失败音效
- `WIN`: 胜利音效

**实现方式**:
```typescript
onAudioPlay(type: AUDIO_EFFECT_ENUM) {
    switch (type) {
        case AUDIO_EFFECT_ENUM.CLICKBUTTON:
            this.audioSource.playOneShot(this.clickButton);
            break;
        case AUDIO_EFFECT_ENUM.CLEAR:
            this.audioSource.playOneShot(this.clear);
            break;
        // ... 其他音效
    }
}
```

## 5. 特效系统

### 5.1 消除特效
**功能描述**: 方块消除时的破碎动画
**实现方式**:
```typescript
onBrokenBuild(pos: Vec2, block: Block) {
    // 生成2-4个碎片
    let nums = getRandom(2, 4);
    
    for (let i = 0; i < nums; i++) {
        // 创建碎片预制体
        let broken = instantiate(this.brokenPrefab[i % 4]);
        
        // 设置精灵帧
        broken.getComponent(Sprite).spriteFrame = 
            this.brokenSpriteAtlas[block.type].getSpriteFrames()[i % 4];
        
        // 应用物理力
        let x = getRandom(-40, 40);
        let y = (i % 2 == 0) ? getRandom(30, 60) : getRandom(-60, -20);
        broken.getComponent(Broken).force(x, y);
    }
}
```

### 5.2 动画系统
**功能描述**: 方块移动和消除动画
**实现方式**:
- 位置插值动画
- 缩放动画
- 透明度动画
- 旋转动画

## 6. 数据管理系统

### 6.1 状态管理
**功能描述**: 游戏状态控制
**状态类型**:
```typescript
enum GAME_STATUS_ENUM {
    INIT,       // 初始化
    RUNNING,    // 运行中
    CLEAR,      // 消除中
    LOSED,      // 失败
    COMPLETE    // 完成
}
```

### 6.2 数据持久化
**功能描述**: 游戏进度保存
**实现方式**:
```typescript
// 存储策略
- 仅保存关卡进度
- localStorage存储
- JSON格式序列化

// 存储内容
{
    level: number  // 当前关卡号
}
```

### 6.3 操作记录
**功能描述**: 撤销功能支持
**实现方式**:
```typescript
// 记录栈管理
records: Block[] = [];  // 操作记录栈

// 记录操作
if (DataManager.instance.records.findIndex(item => item.id == this.id) == -1) {
    DataManager.instance.records.push(this);
}
```

## 7. UI系统

### 7.1 菜单系统
**功能描述**: 主菜单界面
**实现方式**:
```typescript
onGameStart() {
    PLAY_AUDIO.emit(GAME_EVENT_ENUM.PLAY_AUDIO, AUDIO_EFFECT_ENUM.CLICKBUTTON);
    DataManager.instance.reset();
    director.loadScene(GAME_SCENE_ENUM.GAME);
}
```

### 7.2 游戏界面
**功能描述**: 游戏主界面
**界面元素**:
- 游戏区域
- 槽位区域
- 技能按钮
- 状态显示
- 关卡标题

### 7.3 结果界面
**功能描述**: 游戏结束界面
**界面类型**:
- 胜利界面
- 失败界面
- 重试按钮
- 下一关按钮

## 8. 事件系统

### 8.1 事件类型
**功能描述**: 模块间通信
**事件枚举**:
```typescript
enum GAME_EVENT_ENUM {
    CHECK_CLEAR,     // 检查消除
    CHECK_LOSED,     // 检查失败
    CHECK_COMPLETE,  // 检查完成
    CHANGE_BOARD,    // 方块移动
    PLAY_AUDIO,      // 播放音效
    PLAY_BROKEN      // 播放特效
}
```

### 8.2 事件处理
**实现方式**:
```typescript
// 事件注册
CHANGE_BOARD.on(GAME_EVENT_ENUM.CHANGE_BOARD, this.onBoardChange, this);

// 事件触发
CHANGE_BOARD.emit(GAME_EVENT_ENUM.CHANGE_BOARD, this);

// 事件清理
CHANGE_BOARD.off(GAME_EVENT_ENUM.CHANGE_BOARD, this.onBoardChange, this);
```

## 9. 工具系统

### 9.1 随机化工具
**功能描述**: 数组洗牌和随机数生成
**实现方式**:
```typescript
// Fisher-Yates洗牌算法
export function shuffle(arr: any[]) {
    let length = arr.length, randomIndex, temp;
    while (length) {
        randomIndex = Math.floor(Math.random() * (length--));
        temp = arr[randomIndex];
        arr[randomIndex] = arr[length];
        arr[length] = temp;
    }
    return arr;
}

// 随机数生成
export function getRandom(lower: number, upper: number): number {
    return Math.floor(Math.random() * (upper - lower + 1)) + lower;
}
```

### 9.2 类型定义
**功能描述**: TypeScript类型安全
**类型定义**:
```typescript
interface LevelType {
    chessWidthNum: number;
    levelNum: number;
    levelBlockNum: number;
    blockTypeNum: number;
    // ... 其他属性
}

interface BlockType {
    id: number;
    x: number;
    y: number;
    type: number;
    // ... 其他属性
}
```

## 10. 功能总结

### 核心功能
1. **消除机制**: 三层重叠 + 槽位系统
2. **关卡系统**: 4个难度递增关卡
3. **技能系统**: 扩展 + 撤销 + 洗牌
4. **区域系统**: 主游戏区 + 随机区 + 扩展区 + 槽位区

### 辅助功能
1. **音频系统**: 背景音乐 + 音效
2. **特效系统**: 消除动画 + 破碎特效
3. **数据管理**: 状态管理 + 持久化 + 操作记录
4. **UI系统**: 菜单 + 游戏界面 + 结果界面
5. **事件系统**: 模块间通信
6. **工具系统**: 随机化 + 类型定义

### 技术特点
1. **模块化设计**: 功能模块独立
2. **事件驱动**: 松耦合架构
3. **类型安全**: TypeScript强类型
4. **性能优化**: 对象复用 + 轻量存储
5. **用户体验**: 流畅动画 + 完整音效 